{% extends "base.html" %}

{% set current_page = "architecture" %}

{% block title %}Architecture{% endblock %}
{% block page_title %}{{ project_name | default('Project') }} Architecture{% endblock %}
{% block breadcrumb_title %}Architecture{% endblock %}

{% block toc %}
<li class="md-nav__item"><a href="#overview" class="md-nav__link">Overview</a></li>
{% if diagrams.dataflow %}<li class="md-nav__item"><a href="#data-flow" class="md-nav__link">Data Flow</a></li>{% endif %}
<li class="md-nav__item"><a href="#components" class="md-nav__link">Components</a></li>
<li class="md-nav__item"><a href="#modules" class="md-nav__link">Modules</a></li>
<li class="md-nav__item"><a href="#module-structures" class="md-nav__link">Module Structures</a></li>
<li class="md-nav__item"><a href="#all-modules" class="md-nav__link">All Modules</a></li>
{% endblock %}

{% block content %}
<h1 id="overview">{{ project_name | default('Project') }} Architecture</h1>
<p>Comprehensive multi-level view of the system's architectural components, patterns, and relationships.</p>

<!-- Repository Overview -->
<section class="overview-section">
    <h2>üè† Repository Structure</h2>
    <p>High-level overview of the repository organization and main components.</p>
    
    {% if diagrams and diagrams.repository_overview %}
    <div class="diagram-section">
        <div class="mermaid">{{ diagrams.repository_overview.mermaid }}</div>
        <p class="diagram-info">{{ diagrams.repository_overview.description }}</p>
    </div>
    {% endif %}
</section>

<!-- Enterprise Architecture -->
<section class="enterprise-section">
    <h2>üè¢ Enterprise Architecture</h2>
    <p>System-level view showing major components, external integrations, and processing layers.</p>
    
    {% if diagrams and diagrams.enterprise_architecture %}
    <div class="diagram-section">
        <div class="mermaid">{{ diagrams.enterprise_architecture.mermaid }}</div>
        <p class="diagram-info">{{ diagrams.enterprise_architecture.description }}</p>
</div>
{% endif %}
</section>

<!-- Logical Architecture -->
<section class="logical-section">
    <h2>üß† Logical Architecture</h2>
    <p>Component relationships and data flow patterns within the system.</p>
    
    {% if diagrams and diagrams.logical_architecture %}
    <div class="diagram-section">
        <div class="mermaid">{{ diagrams.logical_architecture.mermaid }}</div>
        <p class="diagram-info">{{ diagrams.logical_architecture.description }}</p>
</div>
{% endif %}
</section>

<!-- Physical Architecture -->
<section class="physical-section">
    <h2>üñ•Ô∏è Physical Architecture</h2>
    <p>Deployment environment, runtime components, and infrastructure layout.</p>
    
    {% if diagrams and diagrams.physical_architecture %}
    <div class="diagram-section">
        <div class="mermaid">{{ diagrams.physical_architecture.mermaid }}</div>
        <p class="diagram-info">{{ diagrams.physical_architecture.description }}</p>
</div>
{% endif %}
</section>

<!-- Pipeline Architecture -->
<section class="pipeline-section">
    <h2>‚öôÔ∏è Pipeline Architecture</h2>
    <p>Data processing pipelines, AI enhancement workflows, and content generation flows.</p>
    
    {% if diagrams and diagrams.pipeline_architecture %}
    <div class="diagram-section">
        <div class="mermaid">{{ diagrams.pipeline_architecture.mermaid }}</div>
        <p class="diagram-info">{{ diagrams.pipeline_architecture.description }}</p>
    </div>
    {% endif %}
</section>

<!-- System Component Overview -->
<section class="system-components">
    <h2>üèóÔ∏è System Component Overview</h2>
    <p>High-level view of system components and their architectural relationships.</p>
    
    <div class="getting-started-card">
        <div class="card-icon">üè¢</div>
        <h3>Component Hierarchy</h3>
        <p>Simplified view of main system components and their interactions.</p>
        
        <div class="diagram-section">
            <div class="mermaid">
graph TB
    subgraph "Presentation Layer"
        UI[üñ•Ô∏è User Interface]
        API[üîå API Gateway]
    end
    
    subgraph "Business Layer"
        CORE[üß† Core Logic]
        SERVICES[‚öôÔ∏è Services]
        WORKFLOW[üîÑ Workflows]
    end
    
    subgraph "Data Layer"
        STORAGE[üíæ Data Storage]
        CACHE[‚ö° Cache Layer]
        CONFIG[‚öôÔ∏è Configuration]
    end
    
    UI --> API
    API --> CORE
    CORE --> SERVICES
    SERVICES --> WORKFLOW
    WORKFLOW --> STORAGE
    SERVICES --> CACHE
    CORE --> CONFIG
    
    classDef presentation fill:#e3f2fd,stroke:#1976d2
    classDef business fill:#e8f5e8,stroke:#4caf50
    classDef data fill:#fff3e0,stroke:#ff9800
    
    class UI,API presentation
    class CORE,SERVICES,WORKFLOW business
    class STORAGE,CACHE,CONFIG data
            </div>
            <p class="diagram-info">High-level component architecture showing the three-tier system design with clear separation of concerns.</p>
        </div>
    </div>
</section>

<!-- <section class="components-overview" id="components">
    <h2>üì¶ System Components</h2>
    <p>High-level overview of major system components and their roles.</p>
    <div class="getting-started-grid" id="components-grid"></div>
</section> -->

<!-- High-Level Module Architecture -->
<section class="top-modules-section">
    <h2 id="modules">üìÅ Module Architecture</h2>
    <p>High-level view of core modules and their architectural relationships.</p>
    
    {% if diagrams and diagrams.module_dependency_flow %}
    <div class="diagram-section">
        <h3>Module Dependency Flow</h3>
        <div class="mermaid">{{ diagrams.module_dependency_flow.mermaid }}</div>
        <p class="diagram-info">{{ diagrams.module_dependency_flow.description }}</p>
    </div>
    {% elif modules %}
    <!-- AI-Generated Module Dependency Diagram -->
<div class="diagram-section">
        <h3>Module Dependency Flow: UI ‚Üí Business Logic ‚Üí Features</h3>
        <div class="mermaid">
graph TD
    subgraph "üé® User Interface Layer"
        CLI[üñ•Ô∏è CLI Interface<br/>main.py]
        CONFIG[‚öôÔ∏è Configuration<br/>documentor.yaml]
        TEMPLATES[üìã Templates<br/>html_templates/]
    end
    
    subgraph "üß† Business Logic Layer"
        {% for module in modules[:6] %}
        {% if 'analyzer' in module.path.lower() or 'generator' in module.path.lower() or 'main' in module.path.lower() %}
        M{{ loop.index }}[üìä {{ module.name | title }}<br/>{{ module.path }}]
        {% endif %}
    {% endfor %}
    end
    
    subgraph "üè≠ Product Features"
        DOC_GEN[üìÑ Documentation Generation]
        AI_ENHANCE[ü§ñ AI Enhancement]
        DIAGRAM_CREATE[üìà Diagram Creation]
        CODE_ANALYSIS[üîç Code Analysis]
        HTML_OUTPUT[üåê HTML Output]
    end
    
    subgraph "üíæ Data Layer"
        FILE_IO[üìÅ File Operations]
        CACHE[üíæ Caching System]
        MEMORY[üß† Memory Store]
    end
    
    %% User Interface to Business Logic
    CLI --> M1
    CONFIG --> M1
    TEMPLATES --> M2
    
    %% Business Logic to Features
    M1 --> CODE_ANALYSIS
    M2 --> DOC_GEN
    M3 --> AI_ENHANCE
    M4 --> DIAGRAM_CREATE
    M5 --> HTML_OUTPUT
    
    %% Features to Data Layer
    CODE_ANALYSIS --> FILE_IO
    AI_ENHANCE --> CACHE
    DOC_GEN --> MEMORY
    HTML_OUTPUT --> FILE_IO
    
    %% Cross-layer dependencies
    DOC_GEN --> AI_ENHANCE
    AI_ENHANCE --> DIAGRAM_CREATE
    DIAGRAM_CREATE --> HTML_OUTPUT
    
    classDef ui fill:#e3f2fd
    classDef business fill:#e8f5e8
    classDef features fill:#fff3e0
    classDef data fill:#f3e5f5
    
    class CLI,CONFIG,TEMPLATES ui
    class M1,M2,M3,M4,M5,M6 business
    class DOC_GEN,AI_ENHANCE,DIAGRAM_CREATE,CODE_ANALYSIS,HTML_OUTPUT features
    class FILE_IO,CACHE,MEMORY data
        </div>
        <p class="diagram-info">Module dependency flow showing how user interface components connect through business logic to deliver product features, with data layer support.</p>
            </div>
            {% endif %}

    <!-- Top Modules Summary Table -->
    {% if modules %}
    <div class="top-modules-table">
        <h3>Key Contributing Modules</h3>
        <table>
          <thead>
            <tr>
              <th>Module</th>
              <th>Layer</th>
              <th>Primary Function</th>
              <th>Complexity</th>
              <th>Impact</th>
            </tr>
          </thead>
          <tbody>
            {% for module in modules[:8] %}
            <tr>
              <td><strong>{{ module.name }}</strong><br/><code>{{ module.path }}</code></td>
              <td>
                {% if 'main' in module.path.lower() or 'cli' in module.path.lower() %}
                <span class="layer-badge ui">UI Layer</span>
                {% elif 'analyzer' in module.path.lower() or 'generator' in module.path.lower() %}
                <span class="layer-badge business">Business Logic</span>
                {% elif 'template' in module.path.lower() or 'html' in module.path.lower() %}
                <span class="layer-badge features">Product Features</span>
                {% else %}
                <span class="layer-badge data">Data Layer</span>
                {% endif %}
              </td>
              <td>
                {% if 'analyzer' in module.path.lower() %}
                üîç Code Analysis & Parsing
                {% elif 'generator' in module.path.lower() %}
                üìÑ Documentation Generation
                {% elif 'main' in module.path.lower() %}
                üöÄ Application Orchestration
                {% elif 'template' in module.path.lower() %}
                üìã Template Processing
                {% else %}
                ‚öôÔ∏è System Component
            {% endif %}
              </td>
              <td>
                {% set complexity = (module.functions | length) + (module.classes | length * 2) %}
                <span class="complexity-indicator complexity-{{ 'high' if complexity > 15 else ('medium' if complexity > 5 else 'low') }}">
                  {{ 'High' if complexity > 15 else ('Medium' if complexity > 5 else 'Low') }}
                </span>
              </td>
              <td>
                {% set impact = (module.lines_of_code | default(0)) / 100 + (module.functions | length) + (module.classes | length * 2) %}
                <div class="impact-bar" data-impact="{{ impact | round }}">
                  <div class="impact-fill"></div>
                  <span class="impact-text">{{ impact | round }}</span>
                </div>
              </td>
            </tr>
    {% endfor %}
          </tbody>
        </table>
</div>
{% endif %}
<!-- Module Code Structure (populated by data-integration.js) -->
<!-- <section class="module-structures" id="module-structures">
    <h2>üìÅ Modules</h2>
    <p>Code structure per file with a simple diagram and listed components.</p>
    <div id="modules-structure" class="getting-started-grid"></div>
    
</section> -->

<!-- All Modules Table mirrored under Architecture -->
<!-- <section id="all-modules">
  <h2>All Detected Modules</h2>
  <div class="toolbar" style="margin: 1rem 0; display: flex; gap: .75rem; align-items: center;">
    <input id="all-modules-search" type="search" placeholder="Search modules, paths‚Ä¶" aria-label="Search modules" style="flex:1; padding:.6rem 1rem; border:1px solid var(--color-border); border-radius:.5rem; background: var(--color-bg); color: var(--color-text);">
    <span id="all-modules-count" class="md-nav__count"></span>
  </div>
  <div class="table-responsive">
    <table class="table" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--color-border);">Module</th>
          <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--color-border);">Path</th>
          <th style="text-align:right; padding:.5rem; border-bottom:1px solid var(--color-border);">Functions</th>
          <th style="text-align:right; padding:.5rem; border-bottom:1px solid var(--color-border);">Classes</th>
          <th style="text-align:right; padding:.5rem; border-bottom:1px solid var(--color-border);">Lines</th>
          <th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--color-border);">Description</th>
        </tr>
      </thead>
      <tbody id="all-modules-body"></tbody>
    </table>
  </div>
</section> -->

<style>
/* Top Modules specific styles */
.top-modules-section {
    margin-top: 2rem;
}

.top-modules-table {
    margin-top: 2rem;
}

.layer-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.layer-badge.ui {
    background: #e3f2fd;
    color: #1976d2;
}

.layer-badge.business {
    background: #e8f5e8;
    color: #388e3c;
}

.layer-badge.features {
    background: #fff3e0;
    color: #f57c00;
}

.layer-badge.data {
    background: #f3e5f5;
    color: #7b1fa2;
}

.complexity-indicator {
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.8rem;
    font-weight: 500;
}

.complexity-indicator.complexity-low {
    background: #e8f5e8;
    color: #4caf50;
}

.complexity-indicator.complexity-medium {
    background: #fff3e0;
    color: #ff9800;
}

.complexity-indicator.complexity-high {
    background: #ffebee;
    color: #f44336;
}

.impact-bar {
    position: relative;
    width: 100px;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}

.impact-fill {
    height: 100%;
    background: linear-gradient(90deg, #4caf50, #2196f3);
    transition: width 0.3s ease;
}

.impact-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.7rem;
    font-weight: bold;
    color: #333;
    text-shadow: 0 0 2px rgba(255,255,255,0.8);
}
</style>

<script src="assets/js/mermaid.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  if (window.mermaid) { 
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'default',
      flowchart: { useMaxWidth: true },
      sequence: { useMaxWidth: true },
      classDiagram: { useMaxWidth: true }
    }); 
  }
  
  // Set impact bar widths
  document.querySelectorAll('.impact-bar').forEach(function(bar) {
    const impact = parseInt(bar.getAttribute('data-impact'));
    const percentage = Math.min((impact / 50) * 100, 100);
    const fill = bar.querySelector('.impact-fill');
    if (fill) {
      fill.style.width = percentage + '%';
    }
  });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
  /* Enhanced table visuals for Architecture page section */
  #all-modules .table-responsive {
    border: 1px solid var(--color-border);
    border-radius: .5rem;
    overflow: auto;
    box-shadow: 0 4px 16px rgba(0,0,0,0.05);
    max-height: 60vh;
  }
  #all-modules table thead th {
    position: sticky;
    top: 0;
    background: var(--color-bg);
    z-index: 1;
  }
  #all-modules table tbody tr:nth-child(odd) { background: rgba(0,0,0,0.02); }
  #all-modules table tbody tr:hover { background: rgba(59,130,246,0.08); }
  #all-modules td code {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: inline-block;
    max-width: 40ch;
  }
  #all-modules td:nth-child(3),
  #all-modules td:nth-child(4),
  #all-modules td:nth-child(5) { font-variant-numeric: tabular-nums; width: 6rem; }
  #all-modules thead th:first-child { border-top-left-radius: .5rem; }
  #all-modules thead th:last-child { border-top-right-radius: .5rem; }
</style>
{% endblock %}


